#!/usr/bin/python3/python3

################################################################################
# @file cert_texdiff.py
# @author Marco Israel
# @version GIT
# @date 2021-04-0
# @brief    Compare keyword lines in a file with a corresponding line in b file
#
#
# USAGE: python3 <this>.py <golden-hu.txt> <silver-hu.txt> [--output <out.txt>]
#   <golden-hu.txt>  =   The original human readable txt file in the output
#   <silver-hu.txt>  =   The file to compare with the golden text file
#   [optional:] --output <out.txt>  =   Instead of write to stdout use a file
#
###############################################################################\


import argparse
import difflib
import sys

from pathlib import Path




def _line_diff(golden:str, silver:str, keyword :str, number, output_file: Path = None):

    golden_line = []
    silver_line = []

    with open (golden, "r") as f:
        for line in f:
            if keyword in line:
                golden_line.append(line)
                for _ in range(0,number):
                    golden_line.append(f.__next__())
                break


    with open (silver, "r") as f:
        for line in f:
            if keyword in line:
                silver_line.append(line)
                for _ in range(0,number):
                       silver_line.append(f.__next__())
                break

    delta = difflib.unified_diff(golden_line, silver_line,golden, silver)

    if output_file:
        with open(output_file, "w") as f:
            f.writelines(delta)
    else:
        sys.stdout.writelines(delta)




def main():
    parser = argparse.ArgumentParser()
    parser.add_argument("golden", help="the original reference file to compare")
    parser.add_argument("silver", help="the file to compare with the golden")
    parser.add_argument("--output", help="the output file" )
    args = parser.parse_args()

    golden= Path(args.golden)
    silver= Path(args.silver)

    if args.output:
        output_file = args.output
    else:
        output_file = None

    keyword_list = {"Public-Key":0,
                    "Public Key Algorithm":0,
                    "Signature Algorithm":0,
                    "Issuer":0,
                    "ASN1 OID":0,
                    "NIST CURVE":0,
                    "Authority Key Identifier:":1,
                    "Basic Constraints:":1,
                    "Public Key Info:":1,
                    "Key Usage:":1,
                    "Certificate Policies:":1,
                    "Extended Key Usage:":1,
                    "Subject Directory Attributes:":1}

    for keyword, number in keyword_list.items():
        _line_diff(golden.__str__(), silver.__str__(),                      \
                   keyword.lstrip().rstrip().lstrip(), number, output_file)


if __name__ == "__main__":
    main()

