#!/bin/sh
#
# Author: Matthias Nagel
# Date: 2019-11-21
set -ex

CR_FILE="/tmp/tmp-cr"
CNF_DIR="./cnf"
KEY_DIR="./output/sks"
CERT_DIR="./output/certs"
TA_DIR="./output/tas"


_generateCertificate() {

    THIS=$1
    CA=$CA
    touch "./output/dbs/${BASE_NAME}-index.txt"

    # ecparam:  Generates a private key key *.pen from an elliptic curve (EC)
    openssl ecparam -name secp384r1 -genkey -noout -out "$KEY_DIR/$THIS.pem"

    # req:  Creates certificate in PKCS#10 format and (or) can create self
    #       signed certificates for use as root CAs for example.
    openssl req -new -utf8 -config "$CNF_DIR/$THIS" -key "$KEY_DIR/$THIS.pem" \
        -out $CR_FILE.pem

    if [ $THIS = $CA ]
    then
        # ca:   Sign ROOT certificate given by the input.
        # The self signed root CA certificate needs to include the extensions
        openssl ca -batch -utf8 -config $CNF_DIR/$CA.cnf -create_serial \
                   -extensions self_issued_extensions -selfsign  \
                   -in $CR_FILE.pem -notext -out $TA_DIR/$THIS.pem
    else
        # ca:   Sign USER certificate given by the input.
        openssl ca -batch -utf8 -config $CNF_DIR/$CA -create_serial \
                    -in $CR_FILE.pem -notext -out $CERT_FILE.pem
    fi

        obenssl x509 -inform PEM -in $TA_DIR/$THIS.pem \
            -outform DER -out $TA_DIR/$THIS.der

    rm $CR_FILE
}

# Create Root CA certificate
_createCA_root() {
    BASE_NAME="root-ca-1"
    CACONF_FILE="${BASE_NAME}"

    _generateCertificate $BASE_NAME $CACONF_FILE
}

_createCA_sub() {
    # Create Sub CA certificate
    BASE_NAME="sub-ca-1"
    CACONF_FILE="root-ca-1"
    _generateCertificate $BASE_NAME $CACONF_FILE
}


_createCA_subscriber() {
    # Create a subscriber certificate
    BASE_NAME="subscriber-1"
    CACONF_FILE="${CNF_DIR}/sub-ca-1"

    _generateCertificate $BASE_NAME $CACONF_FILE
}


##### MAIN #####################################################################
_createCA_root

_createCA_sub

_createCA_subscriber
################################################################################

