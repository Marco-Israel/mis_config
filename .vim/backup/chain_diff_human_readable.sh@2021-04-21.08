#!/bin/bash


################################################################################
# @brief    Help
################################################################################
_usage() {
cat <<-EOF
                "${0##*/}"
################################################################################

@author     Marco Israel (MI)
@date       2021
@brief      Batch Wrapper to the correspondig python script to diff all
            human readables certificate (root, sub, subscriber)

@attention      NOTE:   You need to produce the human readable output before.
                        E-g. by verbose call './create-certificates.sh -v [...]'

  USAGE:
 "${0##*/} <path/golden_output>  <path/silver_output>   [ -h, -c, -n ]
    -h / --help     Show this help.
    -c / --clean    Remove the old log file. Default: extend the log file.
    -n / --none / --nooutput    Output only to stdout. No output to a log file.

 @example
 "${0##*/} 1.2.3.4_myRequirement/1_my_test_case -c

################################################################################
# END OF HELP.
EOF
}



################################################################################
# @brief    Main
################################################################################
_main(){
    if [ "$1" = "-h" ] || [ "$1" = "--help" ] || [ "$1" = "-help" ]
    then
        _usage
        exit 0
    fi

    if [ -d "$1"/human_readables ]
    then
        PATH_GOLDEN_CERTS="$1"/human_readables
    else
        PATH_GOLDEN_CERTS="$1"
    fi


    if [ -d "$2"/human_readables ]
    then
        PATH_SILVER_CERTS="$2"/human_readables
    else
        PATH_SILVER_CERTS="$2"
    fi


    if [ ! "$3" ]
    then
        FILE_COMPARE_LOG=./certificate_compare.log
    else
        if [ ! "$3" = "-n" ] && [ ! "$3" = "--none" ] && [ ! "$3" = "-none" ]  \
           &&  [ ! "$3" = "--nooutput" ] &&  [ ! "$3" = "-nooutput" ]
        then
            FILE_COMPARE_LOG=$3
        else
            FILE_COMPARE_LOG="/dev/null"
        fi
    fi


    if [ "$2" = "-c" ] || [ "$2" = "--clean" ]
    then
        rm $FILE_COMPARE_LOG
    fi

    echo "GOLDEN certificate path:  $PATH_GOLDEN_CERTS" >> $FILE_COMPARE_LOG
    echo "SILVER certificate path:  $PATH_SILVER_CERTS" >> $FILE_COMPARE_LOG

    CERT_NAMES=("root-ca-1.cert.txt"    \
        "sub-ca-1.cert.txt"             \
        "subscriber-1.cert.txt")

    for (( i = 0; i < ${#CERT_NAMES[@]}; i++ )); do

        echo "" >> $FILE_COMPARE_LOG
        echo "############################################" >> $FILE_COMPARE_LOG
        echo    CERTIFICATES:  ${CERT_NAMES[$i]} >> $FILE_COMPARE_LOG
        echo "############################################" >> $FILE_COMPARE_LOG

        python3 ./diff_human_readable.py    \
        $PATH_GOLDEN_CERTS/${CERT_NAMES[$i]}    \
        $PATH_SILVER_CERTS/${CERT_NAMES[$i]} | tee -a $FILE_COMPARE_LOG
    done
}
_main $1 $2 $3

### EOF ########################################################################
